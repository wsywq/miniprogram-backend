# 微信小程序 - 习惯打卡系统技术方案

## 1. 技术架构概览

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序端    │    │    后端API服务   │    │     数据库      │
│                 │    │                 │    │                 │
│  - 用户界面      │◄──►│  - RESTful API  │◄──►│  - MySQL/MongoDB│
│  - 本地存储      │    │  - 业务逻辑      │    │  - Redis缓存    │
│  - 微信API调用   │    │  - 数据处理      │    │  - 文件存储     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术选型

#### 前端（小程序端）
- **开发框架**: 微信小程序原生开发
- **UI组件库**: WeUI / Vant Weapp
- **状态管理**: 小程序原生 globalData + 本地存储
- **网络请求**: wx.request 封装
- **本地存储**: wx.setStorageSync / wx.getStorageSync

#### 后端服务
- **开发语言**: Node.js (Express.js) 或 Python (FastAPI)
- **数据库**: MySQL (主数据) + Redis (缓存)
- **文件存储**: 腾讯云COS 或 阿里云OSS
- **认证方式**: JWT + 微信登录
- **部署方式**: Docker + 云服务器

#### 数据库设计
- **关系型数据库**: MySQL 8.0+
- **缓存数据库**: Redis 6.0+
- **连接池**: 数据库连接池管理

## 2. 前端技术方案

### 2.1 项目结构
```
miniprogram/
├── pages/                 # 页面文件
│   ├── index/             # 首页
│   ├── checkin/           # 打卡页
│   ├── statistics/        # 统计页
│   ├── rewards/           # 奖励页
│   └── profile/           # 个人页
├── components/            # 自定义组件
│   ├── habit-card/        # 习惯卡片
│   ├── calendar/          # 日历组件
│   └── chart/             # 图表组件
├── utils/                 # 工具函数
│   ├── api.js            # API请求封装
│   ├── auth.js           # 认证相关
│   ├── storage.js        # 存储管理
│   └── date.js           # 日期处理
├── styles/               # 全局样式
├── images/               # 图片资源
└── app.js/app.json/app.wxss  # 应用配置
```

### 2.2 核心功能实现

#### 用户认证流程
```javascript
// utils/auth.js
class AuthManager {
  async login() {
    // 1. 获取微信登录凭证
    const { code } = await wx.login()
    
    // 2. 获取用户信息授权
    const userInfo = await wx.getUserProfile()
    
    // 3. 发送到后端验证
    const { token, userInfo } = await api.post('/auth/login', {
      code,
      userInfo
    })
    
    // 4. 存储token和用户信息
    wx.setStorageSync('token', token)
    wx.setStorageSync('userInfo', userInfo)
    
    return { token, userInfo }
  }
}
```

#### 数据同步策略
```javascript
// utils/sync.js
class DataSync {
  async syncData() {
    // 1. 检查网络状态
    const networkType = await wx.getNetworkType()
    
    if (networkType === 'none') {
      // 离线模式，数据存储到本地
      return this.saveToLocal(data)
    }
    
    // 2. 同步本地待上传数据
    const pendingData = wx.getStorageSync('pendingSync') || []
    
    for (const item of pendingData) {
      try {
        await api.post('/sync', item)
        // 同步成功，从本地删除
        this.removeFromPending(item.id)
      } catch (error) {
        console.error('同步失败:', error)
      }
    }
  }
}
```

### 2.3 性能优化

#### 页面加载优化
- **分包加载**: 将非核心页面设置为分包
- **图片懒加载**: 使用 `lazy-load` 属性
- **数据预加载**: 关键数据提前请求
- **骨架屏**: 加载过程显示骨架屏

#### 内存管理
- **页面销毁**: 及时清理定时器和监听器
- **图片压缩**: 上传前压缩图片
- **缓存策略**: 合理使用本地存储

## 3. 后端技术方案

### 3.1 API设计

#### RESTful API 规范
```
GET    /api/habits              # 获取习惯列表
POST   /api/habits              # 创建习惯
PUT    /api/habits/:id          # 更新习惯
DELETE /api/habits/:id          # 删除习惯

GET    /api/checkins            # 获取打卡记录
POST   /api/checkins            # 创建打卡记录
PUT    /api/checkins/:id        # 更新打卡记录

GET    /api/statistics          # 获取统计数据
GET    /api/points              # 获取积分记录
POST   /api/points/exchange     # 积分兑换
```

#### 数据库表结构
```sql
-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    openid VARCHAR(100) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(200),
    points INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 习惯表
CREATE TABLE habits (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50),
    category VARCHAR(20),
    frequency VARCHAR(20) DEFAULT 'daily',
    reminder_time TIME,
    status ENUM('active', 'paused', 'deleted') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 打卡记录表
CREATE TABLE checkins (
    id INT PRIMARY KEY AUTO_INCREMENT,
    habit_id INT NOT NULL,
    user_id INT NOT NULL,
    checkin_date DATE NOT NULL,
    checkin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    note TEXT,
    image VARCHAR(200),
    is_makeup BOOLEAN DEFAULT FALSE,
    UNIQUE KEY unique_checkin (habit_id, checkin_date),
    FOREIGN KEY (habit_id) REFERENCES habits(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 积分记录表
CREATE TABLE point_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    points INT NOT NULL,
    type ENUM('earn', 'spend') NOT NULL,
    reason VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 3.2 核心业务逻辑

#### 打卡业务逻辑
```javascript
// services/checkinService.js
class CheckinService {
  async createCheckin(userId, habitId, date, note, image) {
    // 1. 验证是否已打卡
    const existingCheckin = await this.getCheckinByDate(habitId, date)
    if (existingCheckin) {
      throw new Error('今日已打卡')
    }
    
    // 2. 创建打卡记录
    const checkin = await Checkin.create({
      user_id: userId,
      habit_id: habitId,
      checkin_date: date,
      note,
      image
    })
    
    // 3. 计算并发放积分
    await this.calculatePoints(userId, habitId)
    
    // 4. 更新统计数据
    await this.updateStatistics(userId, habitId)
    
    return checkin
  }
  
  async calculatePoints(userId, habitId) {
    // 基础打卡积分
    let points = 10
    
    // 连续打卡奖励
    const streak = await this.getStreakDays(userId, habitId)
    if (streak % 7 === 0) points += 50  // 连续7天奖励
    if (streak % 30 === 0) points += 200 // 连续30天奖励
    
    // 发放积分
    await this.addPoints(userId, points, 'daily_checkin')
  }
}
```

#### 积分系统
```javascript
// services/pointService.js
class PointService {
  async addPoints(userId, points, reason) {
    // 1. 更新用户积分
    await User.increment('points', { by: points, where: { id: userId } })
    
    // 2. 记录积分变化
    await PointRecord.create({
      user_id: userId,
      points,
      type: 'earn',
      reason
    })
    
    // 3. 检查是否达成成就
    await this.checkAchievements(userId)
  }
  
  async spendPoints(userId, points, reason) {
    // 1. 检查积分余额
    const user = await User.findByPk(userId)
    if (user.points < points) {
      throw new Error('积分不足')
    }
    
    // 2. 扣除积分
    await User.decrement('points', { by: points, where: { id: userId } })
    
    // 3. 记录消费
    await PointRecord.create({
      user_id: userId,
      points: -points,
      type: 'spend',
      reason
    })
  }
}
```

### 3.3 缓存策略

#### Redis缓存设计
```javascript
// 用户信息缓存 (TTL: 1小时)
const USER_CACHE_KEY = 'user:info:'
const USER_CACHE_TTL = 3600

// 习惯列表缓存 (TTL: 30分钟)
const HABITS_CACHE_KEY = 'user:habits:'
const HABITS_CACHE_TTL = 1800

// 统计数据缓存 (TTL: 10分钟)
const STATS_CACHE_KEY = 'user:stats:'
const STATS_CACHE_TTL = 600

class CacheService {
  async getUserInfo(userId) {
    const cacheKey = `${USER_CACHE_KEY}${userId}`
    let userInfo = await redis.get(cacheKey)
    
    if (!userInfo) {
      userInfo = await User.findByPk(userId)
      await redis.setex(cacheKey, USER_CACHE_TTL, JSON.stringify(userInfo))
    } else {
      userInfo = JSON.parse(userInfo)
    }
    
    return userInfo
  }
}
```

## 4. 部署方案

### 4.1 服务器配置
- **云服务器**: 腾讯云/阿里云 2核4G起步
- **操作系统**: Ubuntu 20.04 LTS
- **Web服务器**: Nginx (反向代理)
- **应用服务**: PM2 (Node.js进程管理)
- **数据库**: MySQL 8.0 + Redis 6.0

### 4.2 Docker部署
```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
EXPOSE 3000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
  
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: habit_tracker
    volumes:
      - mysql_data:/var/lib/mysql
  
  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

### 4.3 CI/CD流程
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Build and Deploy
        run: |
          docker build -t habit-tracker .
          docker save habit-tracker | gzip > app.tar.gz
          scp app.tar.gz user@server:/tmp/
          ssh user@server 'cd /app && docker load < /tmp/app.tar.gz && docker-compose up -d'
```

## 5. 安全方案

### 5.1 数据安全
- **HTTPS**: 全站HTTPS加密
- **JWT认证**: 接口访问控制
- **数据加密**: 敏感数据加密存储
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输入输出过滤

### 5.2 接口安全
```javascript
// 接口限流
const rateLimit = require('express-rate-limit')

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 最多100次请求
  message: '请求过于频繁，请稍后再试'
})

app.use('/api/', limiter)

// JWT验证中间件
const verifyToken = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1]
  
  if (!token) {
    return res.status(401).json({ error: '未提供认证令牌' })
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    req.user = decoded
    next()
  } catch (error) {
    return res.status(401).json({ error: '无效的认证令牌' })
  }
}
```

## 6. 监控与运维

### 6.1 日志管理
- **应用日志**: Winston + 日志轮转
- **访问日志**: Nginx访问日志
- **错误监控**: Sentry错误追踪
- **性能监控**: New Relic/阿里云监控

### 6.2 备份策略
- **数据库备份**: 每日自动备份
- **文件备份**: 定期备份用户上传文件
- **代码备份**: Git版本控制
- **配置备份**: 配置文件版本管理

## 7. 开发计划

### 7.1 开发阶段
1. **第一阶段 (2周)**: 基础架构搭建 + 核心功能开发
2. **第二阶段 (2周)**: 完善功能 + 界面优化
3. **第三阶段 (1周)**: 测试 + 部署 + 上线

### 7.2 技术风险
- **微信审核**: 小程序审核可能被拒
- **性能问题**: 大量用户并发访问
- **数据一致性**: 离线数据同步问题
- **第三方依赖**: 云服务稳定性

### 7.3 解决方案
- **审核准备**: 严格按照微信规范开发
- **性能优化**: 缓存 + CDN + 数据库优化
- **数据同步**: 冲突检测 + 合并策略
- **服务备份**: 多云部署 + 故障转移
